"use strict";const t=require("../../../../../../common/vendor.js"),i=require("./utils.js"),e=require("../../../../../../common/assets.js"),a={},s={name:"l-clipper",props:{value:{type:Boolean,default:!0},type:{type:String,default:"2d"},customStyle:{type:String},canvasId:{type:String,default:"l-clipper"},zIndex:{type:Number,default:99},imageUrl:{type:String},fileType:{type:String,default:"png"},quality:{type:Number,default:1},width:{type:Number,default:400},height:{type:Number,default:400},minWidth:{type:Number,default:200},maxWidth:{type:Number,default:600},minHeight:{type:Number,default:200},maxHeight:{type:Number,default:600},isLockWidth:{type:Boolean,default:!1},isLockHeight:{type:Boolean,default:!1},isLockRatio:{type:Boolean,default:!0},scaleRatio:{type:Number,default:1},minRatio:{type:Number,default:.5},maxRatio:{type:Number,default:2},isDisableScale:{type:Boolean,default:!1},isDisableRotate:{type:Boolean,default:!1},isLimitMove:{type:Boolean,default:!1},isShowPhotoBtn:{type:Boolean,default:!0},isShowRotateBtn:{type:Boolean,default:!0},isShowConfirmBtn:{type:Boolean,default:!0},isShowCancelBtn:{type:Boolean,default:!0},rotateAngle:{type:Number,default:90},source:{type:Object,default:()=>({album:"从相册中选择",camera:"拍照",message:"从微信中选择"})}},data(){return{canvasWidth:0,canvasHeight:0,clipX:0,clipY:0,clipWidth:0,clipHeight:0,animation:!1,imageWidth:0,imageHeight:0,imageTop:0,imageLeft:0,scale:1,angle:0,image:this.imageUrl,sysinfo:{},throttleTimer:null,throttleFlag:!0,timeClipCenter:null,flagClipTouch:!1,flagEndTouch:!1,clipStart:{},animationTimer:null,touchRelative:[{x:0,y:0}],hypotenuseLength:0,ctx:null}},computed:{clipStyle(){const{clipWidth:t,clipHeight:i,clipY:e,clipX:a,animation:s}=this;return`\n\t\t\twidth: ${t}px;\n\t\t\theight:${i}px;\n\t\t\ttransition-property: ${s?"":"background"};\n\t\t\tleft: ${a}px;\n\t\t\ttop: ${e}px\n\t\t\t`},imageStyle(){const{imageWidth:t,imageHeight:i,imageLeft:e,imageTop:a,animation:s,scale:h,angle:o}=this;return`\n\t\t\t\twidth: ${t?t+"px":"auto"};\n\t\t\t\theight: ${i?i+"px":"auto"};\n\t\t\t\ttransform: translate3d(${e-t/2}px, ${a-i/2}px, 0) scale(${h}) rotate(${o}deg);\n\t\t\t\ttransition-duration: ${s?.35:0}s\n\t\t\t`},clipSize(){const{clipWidth:t,clipHeight:i}=this;return{clipWidth:t,clipHeight:i}},clipPoint(){const{clipY:t,clipX:i}=this;return{clipY:t,clipX:i}}},watch:{value(t){if(t){if(this.imageUrl){const{imageWidth:t,imageHeight:i,imageLeft:e,imageTop:s,scale:h,clipX:o,clipY:n,clipWidth:l,clipHeight:c,path:g}=(null==a?void 0:a[this.imageUrl])||{};g!=this.image?this.image=this.imageUrl:this.setDiffData({imageWidth:t,imageHeight:i,imageLeft:e,imageTop:s,scale:h,clipX:o,clipY:n,clipWidth:l,clipHeight:c})}}else this.animation=0,this.angle=0},imageUrl(t){this.image=t},image:{handler:async function(t){this.getImageInfo(t)}},clipSize({widthVal:t,heightVal:i}){let{minWidth:e,minHeight:a}=this;e/=2,a/=2,t<e&&this.setDiffData({clipWidth:e}),i<a&&this.setDiffData({clipHeight:a}),this.calcClipSize()},angle(t){this.animation=!0,this.moveStop();const{isLimitMove:i}=this;i&&t%90&&this.setDiffData({angle:90*Math.round(t/90)}),this.imgMarginDetectionScale()},animation(t){if(clearTimeout(this.animationTimer),t){let t=setTimeout((()=>{this.setDiffData({animation:!1})}),260);this.setDiffData({animationTimer:t}),this.animationTimer=t}},isLimitMove(t){t&&(this.angle%90&&this.setDiffData({angle:90*Math.round(this.angle/90)}),this.imgMarginDetectionScale())},clipPoint(){this.cutDetectionPosition()},width(t,i){t!==i&&this.setDiffData({clipWidth:t/2})},height(t,i){t!==i&&this.setDiffData({clipHeight:t/2})}},mounted(){const i=t.index.getSystemInfoSync();this.sysinfo=i,this.setClipInfo(),this.image&&this.getImageInfo(this.image),this.setClipCenter(),this.calcClipSize(),this.cutDetectionPosition()},methods:{setDiffData(t){Object.keys(t).forEach((i=>{this[i]!==t[i]&&(this[i]=t[i])}))},getImageInfo(i){i&&(this.value&&t.index.showLoading({title:"请稍候...",mask:!0}),t.index.getImageInfo({src:i,success:t=>{this.imgComputeSize(t.width,t.height),this.image=t.path,this.isLimitMove&&(this.imgMarginDetectionScale(),this.$emit("ready",t));const{imageWidth:e,imageHeight:s,imageLeft:h,imageTop:o,scale:n,clipX:l,clipY:c,clipWidth:g,clipHeight:m}=this;a[i]=Object.assign(t,{imageWidth:e,imageHeight:s,imageLeft:h,imageTop:o,scale:n,clipX:l,clipY:c,clipWidth:g,clipHeight:m})},fail:t=>{this.imgComputeSize(),this.isLimitMove&&this.imgMarginDetectionScale()}}))},setClipInfo(){const{width:i,height:e,sysinfo:a,canvasId:s}=this,h=i/2,o=e/2,n=(a.windowHeight-o)/2,l=(a.windowWidth-h)/2,c=a.windowWidth/2,g=a.windowHeight/2;this.ctx=t.index.createCanvasContext(s,this),this.clipWidth=h,this.clipHeight=o,this.clipX=l,this.clipY=n,this.canvasHeight=o,this.canvasWidth=h,this.imageLeft=c,this.imageTop=g},setClipCenter(){const{sysInfo:i,clipHeight:e,clipWidth:a,imageTop:s,imageLeft:h}=this;let o=i||t.index.getSystemInfoSync(),n=.5*(o.windowHeight-e),l=.5*(o.windowWidth-a);this.imageTop=s-this.clipY+n,this.imageLeft=h-this.clipX+l,this.clipY=n,this.clipX=l},calcClipSize(){const{clipHeight:t,clipWidth:i,sysinfo:e,clipX:a,clipY:s}=this;i>e.windowWidth?this.setDiffData({clipWidth:e.windowWidth}):i+a>e.windowWidth&&this.setDiffData({clipX:e.windowWidth-a}),t>e.windowHeight?this.setDiffData({clipHeight:e.windowHeight}):t+s>e.windowHeight&&(this.clipY=e.windowHeight-s,this.setDiffData({clipY:e.windowHeight-s}))},cutDetectionPosition(){const{clipX:t,clipY:i,sysinfo:e,clipHeight:a,clipWidth:s}=this;let h=()=>{i<0&&this.setDiffData({clipY:0}),i>e.windowHeight-a&&this.setDiffData({clipY:e.windowHeight-a})},o=()=>{t<0&&this.setDiffData({clipX:0}),t>e.windowWidth-s&&this.setDiffData({clipX:e.windowWidth-s})};if(null===i&&null===t){let t=.5*(e.windowHeight-a),i=.5*(e.windowWidth-s);this.setDiffData({clipX:i,clipY:t})}else null!==i&&null!==t?(h(),o()):null!==i&&null===t?(h(),this.setDiffData({clipX:(e.windowWidth-s)/2})):null===i&&null!==t&&(o(),this.setDiffData({clipY:(e.windowHeight-a)/2}))},imgComputeSize(t,e){const{imageWidth:a,imageHeight:s}=i.calcImageSize(t,e,this);this.imageWidth=a,this.imageHeight=s},imgMarginDetectionScale(t){if(!this.isLimitMove)return;const e=i.calcImageScale(this,t);this.imgMarginDetectionPosition(e)},imgMarginDetectionPosition(t){if(!this.isLimitMove)return;const{scale:e,left:a,top:s}=i.calcImageOffset(this,t);this.setDiffData({imageLeft:a,imageTop:s,scale:e})},throttle(){this.setDiffData({throttleFlag:!0})},moveDuring(){clearTimeout(this.timeClipCenter)},moveStop(){clearTimeout(this.timeClipCenter);const t=setTimeout((()=>{this.animation||this.setDiffData({animation:!0}),this.setClipCenter()}),800);this.setDiffData({timeClipCenter:t})},clipTouchStart(e){if(!this.image)return void t.index.showToast({title:"请选择图片",icon:"none",duration:3e3});const a=e.touches[0].clientX,s=e.touches[0].clientY,{clipX:h,clipY:o,clipWidth:n,clipHeight:l}=this,c=i.determineDirection(h,o,n,l,a,s);this.moveDuring(),c&&(this.clipStart={width:n,height:l,x:a,y:s,clipY:o,clipX:h,corner:c},this.flagClipTouch=!0,this.flagEndTouch=!0)},clipTouchMove(e){if(!this.image)return void t.index.showToast({title:"请选择图片",icon:"none",duration:3e3});if(1!==e.touches.length)return;const{flagClipTouch:a,throttleFlag:s}=this;if(a&&s){const{isLockRatio:t,isLockHeight:a,isLockWidth:s}=this;if(t&&(s||a))return;this.setDiffData({throttleFlag:!1}),this.throttle();const h=i.clipTouchMoveOfCalculate(this,e);if(h){const{width:t,height:i,clipX:e,clipY:o}=h;s||a?s?a||this.setDiffData({clipHeight:i,clipY:o}):this.setDiffData({clipWidth:t,clipX:e}):this.setDiffData({clipWidth:t,clipHeight:i,clipX:e,clipY:o}),this.imgMarginDetectionScale()}}},clipTouchEnd(){this.moveStop(),this.flagClipTouch=!1},imageTouchStart(t){this.flagEndTouch=!1;const{imageLeft:e,imageTop:a}=this,s=t.touches[0].clientX,h=t.touches[0].clientY;let o=[];if(1===t.touches.length)o[0]={x:s-e,y:h-a},this.touchRelative=o;else{const n=t.touches[1].clientX,l=t.touches[1].clientY;let c=Math.abs(s-n),g=Math.abs(h-l);const m=i.calcPythagoreanTheorem(c,g);o=[{x:s-e,y:h-a},{x:n-e,y:l-a}],this.touchRelative=o,this.hypotenuseLength=m}},imageTouchMove(t){const{flagEndTouch:e,throttleFlag:a}=this;if(e||!a)return;const s=t.touches[0].clientX,h=t.touches[0].clientY;if(this.setDiffData({throttleFlag:!1}),this.throttle(),this.moveDuring(),1===t.touches.length){const{left:t,top:e}=i.imageTouchMoveOfCalcOffset(this,s,h);this.setDiffData({imageLeft:t,imageTop:e}),this.imgMarginDetectionPosition()}else{const e=t.touches[1].clientX,a=t.touches[1].clientY;let o=Math.abs(s-e),n=Math.abs(h-a),l=i.calcPythagoreanTheorem(o,n),c=this.scale*(l/this.hypotenuseLength);this.isDisableScale?c=1:(c=c<=this.minRatio?this.minRatio:c,c=c>=this.maxRatio?this.maxRatio:c,this.$emit("change",{width:this.imageWidth*c,height:this.imageHeight*c})),this.imgMarginDetectionScale(c),this.hypotenuseLength=Math.sqrt(Math.pow(o,2)+Math.pow(n,2)),this.scale=c}},imageTouchEnd(){this.setDiffData({flagEndTouch:!0}),this.moveStop()},uploadImage(){const i=Object.entries(this.source),e=["original","compressed"],a=({tempFilePaths:t,tempFiles:i})=>{this.image=t?t[0]:i[0].path},s=i=>{"message"!==i&&t.index.chooseImage({count:1,sizeType:e,sourceType:[i],success:a}),"message"==i&&t.wx$1.chooseMessageFile({count:1,type:"image",success:a})};i.length>1?t.index.showActionSheet({itemList:i.map((t=>t[1])),success:({tapIndex:t})=>{s(i[t][0])}}):s(i[0][0])},imageReset(){const i=this.sysinfo||t.index.getSystemInfoSync();this.scale=1,this.angle=0,this.imageTop=i.windowHeight/2,this.imageLeft=i.windowWidth/2},imageLoad(i){this.imageReset(),t.index.hideLoading(),this.$emit("ready",i.detail)},rotate(i){if(this.isDisableRotate)return;if(!this.image)return void t.index.showToast({title:"请选择图片",icon:"none",duration:3e3});const{rotateAngle:e}=this,a=this.angle,s=i.currentTarget.dataset.type;this.angle="along"===s?a+e:a-e,this.$emit("rotate",this.angle)},confirm(){if(!this.image)return void t.index.showToast({title:"请选择图片",icon:"none",duration:3e3});t.index.showLoading({title:"加载中"});const{canvasHeight:i,canvasWidth:e,clipHeight:a,clipWidth:s,ctx:h,scale:o,imageLeft:n,imageTop:l,clipX:c,clipY:g,angle:m,scaleRatio:p,image:d,quality:r,fileType:u,type:f,canvasId:w}=this,D=()=>{const i=this.imageWidth*o*p,e=this.imageHeight*o*p,f=n-c,D=l-g;h.translate(f*p,D*p),h.rotate(m*Math.PI/180),h.drawImage(d,-i/2,-e/2,i,e),h.draw(!1,(()=>{const i=s*p,e=a*p;let h={x:0,y:0,width:i,height:e,destWidth:i,destHeight:e,canvasId:w,fileType:u,quality:r,success:i=>{o.url=i.tempFilePath,t.index.hideLoading(),this.$emit("success",o),this.$emit("input",!1)},fail:t=>{console.error("error",t),this.$emit("fail",t),this.$emit("input",!1)}},o={url:"",width:i,height:e};t.index.canvasToTempFilePath(h,this)}))};e!==s||i!==a?(this.canvasWidth=s,this.canvasHeight=a,h.draw(),this.$nextTick((()=>{setTimeout((()=>{D()}),100)}))):D()},cancel(){this.$emit("cancel",!1),this.$emit("input",!1)}}};const h=t._export_sfc(s,[["render",function(i,a,s,h,o,n){return t.e({a:t.f([0,0,0,0],((t,i,e)=>({a:i}))),b:t.s(n.clipStyle),c:t.o(((...t)=>n.clipTouchStart&&n.clipTouchStart(...t))),d:t.o(((...t)=>n.clipTouchMove&&n.clipTouchMove(...t))),e:t.o(((...t)=>n.clipTouchEnd&&n.clipTouchEnd(...t))),f:o.image},o.image?{g:t.o(((...t)=>n.imageLoad&&n.imageLoad(...t))),h:t.o(((...t)=>n.imageLoad&&n.imageLoad(...t))),i:t.o(((...t)=>n.imageTouchStart&&n.imageTouchStart(...t))),j:t.o(((...t)=>n.imageTouchMove&&n.imageTouchMove(...t))),k:t.o(((...t)=>n.imageTouchEnd&&n.imageTouchEnd(...t))),l:o.image,m:"auto"==o.imageWidth?"widthFix":"",n:t.s(n.imageStyle)}:{},{o:s.canvasId,p:t.s("width: "+o.canvasWidth*s.scaleRatio+"px; height:"+o.canvasHeight*s.scaleRatio+"px;"),q:s.isShowCancelBtn},s.isShowCancelBtn?t.e({r:i.$slots.cancel},(i.$slots.cancel,{}),{s:t.o(((...t)=>n.cancel&&n.cancel(...t)))}):{},{t:s.isShowPhotoBtn},s.isShowPhotoBtn?t.e({v:i.$slots.photo},i.$slots.photo?{}:{w:e._imports_0$3},{x:t.o(((...t)=>n.uploadImage&&n.uploadImage(...t)))}):{},{y:s.isShowRotateBtn},s.isShowRotateBtn?t.e({z:i.$slots.rotate},i.$slots.rotate?{}:{A:e._imports_1$1},{B:t.o(((...t)=>n.rotate&&n.rotate(...t)))}):{},{C:s.isShowConfirmBtn},s.isShowConfirmBtn?t.e({D:i.$slots.confirm},(i.$slots.confirm,{}),{E:t.o(((...t)=>n.confirm&&n.confirm(...t)))}):{},{F:s.value?1:"",G:t.s("z-index: "+s.zIndex+";"+s.customStyle)})}],["__scopeId","data-v-e2c525e0"]]);wx.createComponent(h);
